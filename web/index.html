<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Patient Intelligence Explorer</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700;1,9..40,400&family=Petrona:wght@400;500;600;700&family=IBM+Plex+Mono:wght@400;500&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/styles.css" />
</head>
<body>

  <!-- Top Navigation Bar -->
  <nav class="topbar">
    <div class="topbar-brand">
      <div class="topbar-logo">W</div>
      <div>
        <h1 class="topbar-title">Patient Intelligence Explorer</h1>
        <p class="topbar-subtitle">WELL Health Technologies &middot; Hackathon 2026</p>
      </div>
    </div>
    <div class="topbar-actions">
      <span class="topbar-badge">TSX: WELL</span>
      <button id="toggleAllMask" class="action-btn" type="button" aria-pressed="false">
        <span class="eye-icon" aria-hidden="true"></span>
        <span class="toggle-label">Reveal sensitive data</span>
      </button>
    </div>
  </nav>

  <!-- Three-Panel Application Shell -->
  <div class="app-shell">

    <!-- Left: Icon Sidebar -->
    <aside class="icon-nav">
      <button class="icon-nav-btn active" data-panel="patients" title="Patients">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
        <span>Patients</span>
      </button>
      <button class="icon-nav-btn" data-panel="filters" title="Filters">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></svg>
        <span>Filters</span>
      </button>
      <div class="icon-nav-spacer"></div>
      <div class="icon-nav-stats" id="navStats" title="Dataset summary"></div>
    </aside>

    <!-- Middle: Patient List -->
    <section class="middle-panel" id="middlePanel">

      <!-- Patient List View (default) -->
      <div class="list-view" id="patientListView">
        <div class="list-header search-wrapper">
          <input id="q" type="search" class="list-search" placeholder="Search patients... (use @prefix for keyword lookup)" />
          <div id="esDropdown" class="es-dropdown"></div>
        </div>
        <div class="list-filters-active" id="activeFilterBadges"></div>
        <div class="list-content" id="patientList">
          <!-- Patient rows rendered here -->
        </div>
        <div class="list-footer" id="listFooter">
          <span id="resultMeta"></span>
        </div>
      </div>

      <!-- Filter Panel View (toggled) -->
      <div class="filter-view hidden" id="filterPanelView">
        <div class="filter-head">
          <h2>Filters</h2>
          <button id="clearFilters" type="button" class="link-btn">Clear all</button>
        </div>
        <div class="filter-section">
          <label>City
            <select id="city"><option value="">All</option></select>
          </label>
          <label>Province
            <select id="province"><option value="">All</option></select>
          </label>
          <label>Sex / Gender
            <select id="sex_gender"><option value="">All</option></select>
          </label>
          <label>Ethnicity
            <select id="ethnicity"><option value="">All</option></select>
          </label>
          <label>Known Allergy
            <select id="known_allergy">
              <option value="all">All</option>
              <option value="yes">Yes</option>
              <option value="no">No</option>
            </select>
          </label>
          <label>Organization
            <select id="organization"><option value="">All</option></select>
          </label>
          <label>Practitioner
            <select id="practitioner"><option value="">All</option></select>
          </label>
          <label>Encounter Type
            <select id="encounter_type"><option value="">All</option></select>
          </label>
          <label>Care Setting
            <select id="setting"><option value="">All</option></select>
          </label>
          <div class="range-row">
            <label>Min Age
              <input id="min_age" type="number" min="0" max="120" placeholder="0" />
            </label>
            <label>Max Age
              <input id="max_age" type="number" min="0" max="120" placeholder="120" />
            </label>
          </div>
          <div class="range-row">
            <label>Encounter From
              <input id="date_from" type="date" />
            </label>
            <label>Encounter To
              <input id="date_to" type="date" />
            </label>
          </div>
        </div>
      </div>
    </section>

    <!-- Right: Detail Panel + Ask AI -->
    <section class="detail-panel">

      <!-- Empty state (no patient selected) -->
      <div class="detail-empty" id="detailEmpty">
        <div class="detail-empty-inner">
          <div class="detail-empty-icon">
            <svg viewBox="0 0 24 24" width="40" height="40" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
          </div>
          <h3>Select a patient</h3>
          <p>Choose a patient from the list to view their encounter timeline, clinical summary, and more.</p>
        </div>
      </div>

      <!-- Patient detail (shown when selected) -->
      <div class="detail-content hidden" id="detailContent">
        <header class="detail-header">
          <div>
            <h2 id="detailPatientName" class="detail-name"></h2>
            <p id="detailPatientMeta" class="detail-meta"></p>
          </div>
          <button id="detailRevealBtn" class="eye-btn" type="button" title="Toggle sensitive data">
            <span class="eye-icon" aria-hidden="true"></span>
          </button>
        </header>

        <div class="detail-summary" id="detailSummary">
          <div class="summary-grid">
            <div>
              <p class="label">Problem List</p>
              <p id="detailProblems" class="value"></p>
            </div>
            <div>
              <p class="label">Allergies</p>
              <p id="detailAllergies" class="value sensitive"></p>
            </div>
            <div>
              <p class="label">Medications</p>
              <p id="detailMeds" class="value sensitive"></p>
            </div>
            <div>
              <p class="label">Organizations</p>
              <p id="detailOrgs" class="value"></p>
            </div>
          </div>
        </div>

        <div class="detail-timeline" id="detailTimeline">
          <div class="timeline-head">
            <h3>Encounter Timeline</h3>
          </div>
          <div id="detailEncounterList" class="timeline-list">
            <!-- Encounter items rendered here -->
          </div>
        </div>
      </div>

      <!-- Ask AI Bar (always visible at bottom of right panel) -->
      <div class="ask-ai-bar" id="askAiBar">
        <div class="ask-ai-messages" id="chatMessages">
          <div class="chat-welcome">
            <p>Ask about patient records, conditions, or metrics.</p>
            <p class="chat-welcome-hint">Try: "Which patients have diabetes?" or "Chart A1C for Eleanor Voss"</p>
          </div>
        </div>
        <form id="chatForm" class="ask-ai-input">
          <div class="ask-ai-orb">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M12 3c-4.97 0-9 3.18-9 7.1 0 2.34 1.52 4.42 3.86 5.72L5.5 20l3.96-2.07A10.6 10.6 0 0 0 12 18.2c4.97 0 9-3.18 9-7.1S16.97 3 12 3z"/>
            </svg>
          </div>
          <input id="chatInput" type="text" placeholder="Ask AI anything about patients..." autocomplete="off" />
          <button type="submit" class="ask-ai-send" aria-label="Send">
            <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/>
            </svg>
          </button>
          <button type="button" id="chatClear" class="ask-ai-clear" title="Clear conversation">
            <svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
            </svg>
          </button>
          <div id="chatMentionList" class="chat-mention-list" hidden></div>
        </form>
      </div>
    </section>
  </div>

  <!-- Encounter Dialog (kept for citation deep-links from chat) -->
  <dialog id="encounterDialog" class="encounter-dialog">
    <form method="dialog" class="dialog-shell">
      <header class="dialog-head">
        <div>
          <p class="dialog-kicker">Encounter Timeline</p>
          <h3 id="dialogPatientName"></h3>
          <p id="dialogPatientMeta" class="dialog-meta"></p>
        </div>
        <button type="submit" class="dialog-close-btn" aria-label="Close dialog">
          <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
          </svg>
        </button>
      </header>
      <section class="dialog-snapshot">
        <div>
          <p class="label">Problem List</p>
          <p id="dialogProblemList" class="value"></p>
        </div>
        <div>
          <p class="label">Allergies</p>
          <p id="dialogAllergies" class="value sensitive"></p>
        </div>
        <div>
          <p class="label">Medication Summary</p>
          <p id="dialogMeds" class="value sensitive"></p>
        </div>
      </section>
      <section id="dialogEncounterList" class="dialog-encounters"></section>
    </form>
  </dialog>

  <script src="/app.js" defer></script>
</body>
</html>
